# DurableTask.PostgresSQL - Architecture Overview

```
???????????????????????????????????????????????????????????????????????
?                    DurableTask.PostgresSQL                          ?
?                 PostgreSQL Provider for Durable Task Framework      ?
???????????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????????
?                        APPLICATION LAYER                             ?
???????????????????????????????????????????????????????????????????????
?  TaskHubWorker  ?  TaskHubClient  ?  Orchestrations  ?  Activities  ?
???????????????????????????????????????????????????????????????????????
             ?
             ? Uses
             ?
???????????????????????????????????????????????????????????????????????
?                   DurableTask.Core (NuGet 3.6.1)                    ?
???????????????????????????????????????????????????????????????????????
?  IOrchestrationService ? IOrchestrationServiceClient ? ...          ?
???????????????????????????????????????????????????????????????????????
             ?
             ? Implements
             ?
???????????????????????????????????????????????????????????????????????
?                    SERVICE IMPLEMENTATION                            ?
???????????????????????????????????????????????????????????????????????
?                                                                      ?
?  ??????????????????????????????????????????????????????????????   ?
?  ?          PostgresOrchestrationService.cs                   ?   ?
?  ?  ????????????????????????????????????????????????????????  ?   ?
?  ?  ? • LockNextTaskOrchestrationWorkItemAsync()         ?  ?  ?   ?
?  ?  ? • CompleteTaskOrchestrationWorkItemAsync()         ?  ?  ?   ?
?  ?  ? • LockNextTaskActivityWorkItem()                   ?  ?  ?   ?
?  ?  ? • CompleteTaskActivityWorkItemAsync()              ?  ?  ?   ?
?  ?  ? • CreateTaskOrchestrationAsync()                   ?  ?  ?   ?
?  ?  ? • SendTaskOrchestrationMessageAsync()              ?  ?  ?   ?
?  ?  ? • GetOrchestrationStateAsync()                     ?  ?  ?   ?
?  ?  ? • PurgeInstanceStateAsync()                        ?  ?  ?   ?
?  ?  ????????????????????????????????????????????????????????  ?   ?
?  ?                            ?                                 ?   ?
?  ?         ???????????????????????????????????????            ?   ?
?  ?         ?                                       ?            ?   ?
?  ?         ?                                       ?            ?   ?
?  ?  ???????????????????                  ???????????????????? ?   ?
?  ?  ? PostgresUtils   ?                  ? PostgresDbManager? ?   ?
?  ?  ???????????????????                  ???????????????????? ?   ?
?  ?  ? • ExecuteReader ?                  ? • CreateSchema   ? ?   ?
?  ?  ? • ExecuteNonQuery?                 ? • UpgradeSchema  ? ?   ?
?  ?  ? • Retry Logic   ?                  ? • DeleteSchema   ? ?   ?
?  ?  ? • Error Handling?                  ? • Advisory Locks ? ?   ?
?  ?  ???????????????????                  ???????????????????? ?   ?
?  ?           ?                                     ?           ?   ?
?  ???????????????????????????????????????????????????????????????   ?
?              ?                                     ?               ?
??????????????????????????????????????????????????????????????????????
               ?                                     ?
               ? Uses Npgsql 9.0.2                  ?
               ?                                     ?
???????????????????????????????????????????????????????????????????????
?                       DATABASE LAYER                                ?
???????????????????????????????????????????????????????????????????????
?                    PostgreSQL Database                               ?
?                                                                      ?
?  ??????????????????????????????????????????????????????????????   ?
?  ?                      SCHEMA (dt)                           ?   ?
?  ??????????????????????????????????????????????????????????????   ?
?  ?                                                            ?   ?
?  ?  TABLES (7)                                               ?   ?
?  ?  ??????????????????????????????????????????????????????  ?   ?
?  ?  ? Instances    ? NewEvents    ? History              ?  ?   ?
?  ?  ? Payloads     ? NewTasks     ? Versions             ?  ?   ?
?  ?  ? GlobalSettings                                      ?  ?   ?
?  ?  ??????????????????????????????????????????????????????  ?   ?
?  ?                                                            ?   ?
?  ?  INDEXES (3+)                                             ?   ?
?  ?  • IX_Instances_RuntimeStatus                            ?   ?
?  ?  • IX_Instances_CreatedTime                              ?   ?
?  ?  • IX_NewTasks_InstanceID                                ?   ?
?  ?                                                            ?   ?
?  ?  FUNCTIONS (26+)                                          ?   ?
?  ?  ??????????????????????????????????????????????????????  ?   ?
?  ?  ? Core Functions                                     ?  ?   ?
?  ?  ?  • CurrentTaskHub()                                ?  ?   ?
?  ?  ?  • GetScaleMetric()                                ?  ?   ?
?  ?  ?  • GetScaleRecommendation()                        ?  ?   ?
?  ?  ?  • CreateInstance()                                ?  ?   ?
?  ?  ?  • _GetVersions()                                  ?  ?   ?
?  ?  ??????????????????????????????????????????????????????  ?   ?
?  ?  ? Instance Operations                                ?  ?   ?
?  ?  ?  • GetInstanceHistory()                            ?  ?   ?
?  ?  ?  • RaiseEvent()                                    ?  ?   ?
?  ?  ?  • TerminateInstance()                             ?  ?   ?
?  ?  ?  • PurgeInstanceStateByID()                        ?  ?   ?
?  ?  ?  • PurgeInstanceStateByTime()                      ?  ?   ?
?  ?  ?  • SetGlobalSetting()                              ?  ?   ?
?  ?  ??????????????????????????????????????????????????????  ?   ?
?  ?  ? Work Item Locking (Critical!)                      ?  ?   ?
?  ?  ?  • _LockNextOrchestration()      ???            ?  ?   ?
?  ?  ?  • _CheckpointOrchestration()    ???            ?  ?   ?
?  ?  ??????????????????????????????????????????????????????  ?   ?
?  ?  ? Activity Tasks & Queries                           ?  ?   ?
?  ?  ?  • _LockNextTask()                                 ?  ?   ?
?  ?  ?  • _RenewOrchestrationLocks()                      ?  ?   ?
?  ?  ?  • _RenewTaskLocks()                               ?  ?   ?
?  ?  ?  • _CompleteTasks()                                ?  ?   ?
?  ?  ?  • QuerySingleOrchestration()                      ?  ?   ?
?  ?  ?  • _QueryManyOrchestrations()                      ?  ?   ?
?  ?  ?  • _DiscardEventsAndUnlockInstance()               ?  ?   ?
?  ?  ?  • _AddOrchestrationEvents()                       ?  ?   ?
?  ?  ??????????????????????????????????????????????????????  ?   ?
?  ?                                                            ?   ?
?  ?  VIEWS (2)                                                ?   ?
?  ?  • vInstances - Instances with payload text              ?   ?
?  ?  • vHistory - History with payload text                  ?   ?
?  ?                                                            ?   ?
?  ??????????????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????????
?                      LOGGING & MONITORING                            ?
???????????????????????????????????????????????????????????????????????
?                                                                      ?
?  ??????????????????????    ????????????????????????????????????   ?
?  ?    LogHelper       ??????  DefaultEventSource (ETW)        ?   ?
?  ?                    ?    ?  "DurableTask-PostgresSQL"       ?   ?
?  ?  • 12+ Event Types ?    ????????????????????????????????????   ?
?  ?  • ILogger Support ?                                            ?
?  ?  • Structured Logs ?    ????????????????????????????????????   ?
?  ???????????????????????????  ILogger (Microsoft.Extensions)  ?   ?
?                             ????????????????????????????????????   ?
???????????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????????
?                         DATA FLOW                                    ?
???????????????????????????????????????????????????????????????????????
?                                                                      ?
?  Orchestration Execution:                                           ?
?  1. Client creates instance                                         ?
?  2. CreateInstance() ? Instances + NewEvents tables                 ?
?  3. Worker calls LockNextOrchestration()                            ?
?  4. _LockNextOrchestration() returns work item                      ?
?  5. Worker executes orchestration logic                             ?
?  6. Worker calls CompleteOrchestration()                            ?
?  7. _CheckpointOrchestration() saves state                          ?
?  8. Repeat until orchestration completes                            ?
?                                                                      ?
?  Activity Execution:                                                ?
?  1. Orchestration schedules activity ? NewTasks table               ?
?  2. Worker calls LockNextTask()                                     ?
?  3. _LockNextTask() returns task                                    ?
?  4. Worker executes activity logic                                  ?
?  5. Worker calls CompleteTask()                                     ?
?  6. _CompleteTasks() saves result ? NewEvents table                 ?
?                                                                      ?
???????????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????????
?                    KEY TECHNOLOGIES                                  ?
???????????????????????????????????????????????????????????????????????
?                                                                      ?
?  • .NET 10.0                                                        ?
?  • C# 13 with nullable reference types                             ?
?  • Npgsql 9.0.2 (PostgreSQL .NET driver)                           ?
?  • PostgreSQL 12+ (recommended 14+)                                ?
?  • JSONB for complex data structures                               ?
?  • Advisory locks for coordination                                 ?
?  • Row-level locking with SKIP LOCKED                              ?
?  • ETW (Event Tracing for Windows) for monitoring                  ?
?                                                                      ?
???????????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????????
?                     STATUS LEGEND                                    ?
???????????????????????????????????????????????????????????????????????
?                                                                      ?
?  ? Complete and tested                                             ?
?  ??  Complete but needs implementation                              ?
?  ? Pending / TODO                                                  ?
?  ? Critical/Complex function                                       ?
?  ?  Calls PostgreSQL function                                      ?
?                                                                      ?
???????????????????????????????????????????????????????????????????????
```

## File Organization

```
DurableTask.PostgresSQL/
??? *.csproj                              # Project file
??? README.md                             # Main documentation
??? SUMMARY.md                            # Project summary
??? ARCHITECTURE.md                       # This file
?
??? Core Service Files
?   ??? PostgresOrchestrationService.cs   # Main service
?   ??? PostgresOrchestrationServiceSettings.cs
?   ??? PostgresDbManager.cs
?   ??? PostgresUtils.cs
?   ??? DTUtils.cs
?   ??? BackoffPollingHelper.cs
?   ??? AssemblyInfo.cs
?
??? Utils/
?   ??? OrchestrationServiceBase.cs
?   ??? AsyncAutoResetEvent.cs
?
??? Logging/
?   ??? LogHelper.cs
?   ??? LogEvents.cs
?   ??? EventIds.cs
?   ??? DefaultEventSource.cs
?
??? Scripts/
    ??? README.md                         # SQL scripts documentation
    ??? schema-1.0.0.sql                  # Database schema
    ??? logic-1.0.0.sql                   # Core functions
    ??? logic-1.0.0-part2.sql            # Instance operations
    ??? logic-1.0.0-part3.sql            # Locking & checkpoints
    ??? logic-1.0.0-part4.sql            # Activities & queries
    ??? drop-schema.sql                   # Cleanup script
```

## Implementation Priority

### ?? High Priority (Core Functionality)
1. `_LockNextOrchestration()` - Get work items
2. `_CheckpointOrchestration()` - Save state
3. `_LockNextTask()` - Get activities
4. `_CompleteTasks()` - Complete activities
5. JSONB serialization helpers

### ?? Medium Priority (Essential Features)
1. `CreateInstance()` - Start orchestrations
2. `RaiseEvent()` - Send events
3. `TerminateInstance()` - Stop orchestrations
4. Query functions
5. Error handling improvements

### ?? Low Priority (Nice to Have)
1. Performance optimizations
2. LISTEN/NOTIFY integration
3. Advanced monitoring
4. Migration tools
5. Admin utilities

---

**Total Lines of Code**: ~6,300  
**Total Files**: 26  
**Build Status**: ? Successful  
**Ready for**: Implementation phase
